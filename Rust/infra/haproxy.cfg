global
    log stdout format raw local0
    maxconn 4096

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms
    timeout check   5000ms
    
# WebSocket specific timeouts
defaults websocket
    mode    http
    option  httplog
    timeout connect 5000ms
    timeout client  3600000ms  # 1 hour for WebSocket
    timeout server  3600000ms  # 1 hour for WebSocket
    timeout tunnel  3600000ms  # 1 hour for WebSocket tunnel

# Stats page
listen stats
    bind *:8404
    stats enable
    stats uri /
    stats refresh 10s
    stats admin if TRUE
    stats show-legends
    stats show-node

# Frontend - Entry point
frontend gateway_frontend
    bind *:8080
    default_backend gateway_backend

# Backend - Gateway instances
backend gateway_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    # Three gateway instances
    server gateway-1 gateway-1:8083 check inter 3s fall 3 rise 2
    server gateway-2 gateway-2:8083 check inter 3s fall 3 rise 2
    server gateway-3 gateway-3:8083 check inter 3s fall 3 rise 2

# Frontend - Chat WebSocket ONLY (Public - for browser WebSocket connections)
# This port should ONLY be used for WebSocket connections from browser
frontend chat_websocket_frontend
    bind *:8085
    
    # WebSocket upgrade headers
    acl is_websocket hdr(Upgrade) -i WebSocket
    acl is_websocket hdr_beg(Host) -i ws
    
    # WebSocket connections with sticky sessions
    default_backend chat_websocket_backend

# Frontend - Chat HTTP API ONLY (Internal - for Next.js server-side API calls)
# This port should ONLY be used by Next.js API routes, NOT exposed to public
frontend chat_api_frontend
    bind *:8086
    
    # Internal API calls use round-robin load balancing
    default_backend chat_api_backend

# Backend - Chat service with sticky sessions (for WebSocket connections)
backend chat_websocket_backend
    # Sticky sessions based on source IP for WebSocket
    balance source
    hash-type consistent
    
    # WebSocket specific options
    option http-server-close
    option forwardfor
    
    # Health check
    option httpchk GET /health
    http-check expect status 200
    
    # Chat service instances
    server chat-1 chat-service-1:8084 check inter 5s fall 3 rise 2
    server chat-2 chat-service-2:8084 check inter 5s fall 3 rise 2
    server chat-3 chat-service-3:8084 check inter 5s fall 3 rise 2

# Backend - Chat API with round-robin (for internal HTTP API calls)
backend chat_api_backend
    # Round-robin load balancing for API calls
    balance roundrobin
    
    # HTTP specific options
    option http-server-close
    option forwardfor
    
    # Health check
    option httpchk GET /health
    http-check expect status 200
    
    # Chat service instances
    server chat-1 chat-service-1:8084 check inter 5s fall 3 rise 2
    server chat-2 chat-service-2:8084 check inter 5s fall 3 rise 2
    server chat-3 chat-service-3:8084 check inter 5s fall 3 rise 2
